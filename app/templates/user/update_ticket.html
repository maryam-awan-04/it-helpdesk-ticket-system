<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Help Desk | Update Ticket</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='user.css') }}">
</head>
<body>
    <div class="main-container">
        <div class="sidebar-container">
            <div class="sidebar">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="IT Help Desk Logo" class="logo">
                </div>
                <div class="user-info">
                    <h2>Welcome [User]!</h2>
                </div>
                <nav class="navigation">
                    <ul>
                        <li><a href="{{ url_for('user.dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('user.create_ticket') }}">Create New Ticket</a></li>
                        <li class="active"><a href="#">Update Ticket</a></li>
                    </ul>
                </nav>
                <div class="logout-container">
                    <button class="logout-button">Sign Out</button>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="history-container">
                <h2>Select Ticket to Update</h2>
                <ul class="ticket-list" id="ticketList">
                    {% if tickets %}
                        {% for ticket in tickets %}
                            <li class="ticket-item" data-ticket-id="{{ ticket.id }}"
                                data-request-type="{{ ticket.request_type }}"
                                data-title="{{ ticket.title }}"
                                data-description="{{ ticket.description }}">
                                Ticket #{{ ticket.id }} - {{ ticket.title }}
                            </li>
                        {% endfor %}
                    {% else %}
                        <li>No tickets available to update.</li>
                    {% endif %}
                </ul>
            </div>

            <div class="edit-form-container">
                <h2>Edit Ticket Details</h2>
                <form method="POST" id="updateTicketForm">
                    {{ form.hidden_tag() }}
                    <div class="form-group">
                        {{ form.request_type.label }}
                        {{ form.request_type(class="form-control", id="request_type", readonly=true) }}
                        {% if form.request_type.errors %}
                            <ul class="errors">
                            {% for error in form.request_type.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.title.label }}
                        {{ form.title(class="form-control", id="title_edit") }}
                        {% if form.title.errors %}
                            <ul class="errors">
                            {% for error in form.title.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.description.label }}
                        {{ form.description(class="form-control", rows="5", id="description_edit") }}
                        {% if form.description.errors %}
                            <ul class="errors">
                            {% for error in form.description.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                    <button type="button" class="submit-button" id="submitEditDetails">Submit Changes</button>
                </form>
            </div>

            <div class="details-container">
                <div class="ticket-details" id="ticketDetails">
                    <h2>Ticket Details</h2>
                    <p>Date: <span id="ticketDate">-</span></p>
                    <p>Email: <span id="ticketEmail">-</span></p>
                    <p>Request Type: <span id="ticketRequestType">-</span></p>
                    <p>Title: <span id="ticketTitle">-</span></p>
                    <p>Description: <span id="ticketDescription">-</span></p>
                    <div class="button-container">
                        <button type="button" class="edit-button" id="editDetails" disabled>Edit Details</button>
                        <form method="POST">
                            {{ form.hidden_tag() }}
                            <input type="hidden" id="final_ticket_id" name="ticket_id">
                            <input type="hidden" id="final_request_type" name="request_type">
                            <input type="hidden" id="final_title" name="title">
                            <input type="hidden" id="final_description" name="description">
                            <button type="submit" class="create-ticket-button" id="updateTicketFinal" disabled name="update_ticket">Update Ticket</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="customAlert" class="custom-alert">
        <div class="alert-content">
            <p id="alertMessage"></p>
            <button id="alertOkayButton">Okay</button>
        </div>
    </div>

    <div id="customAlertLogout" class="custom-alert-logout" style="display: none;">
        <div class="alert-content">
            <p id="alertMessage">Are you sure you want to sign out?</p>
            <button id="alertYesButton">Yes</button>
            <button id="alertNoButton">No</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const ticketList = document.getElementById("ticketList");
            const updateTicketForm = document.getElementById("updateTicketForm");
            const submitEditDetailsButton = document.getElementById("submitEditDetails");
            const ticketDetailsSection = document.getElementById("ticketDetails");
            const editDetailsButton = document.getElementById("editDetails");
            const updateTicketFinalButton = document.getElementById("updateTicketFinal");
            const requestTypeEdit = document.getElementById("request_type_edit");
            const titleEdit = document.getElementById("title_edit");
            const descriptionEdit = document.getElementById("description_edit");
            const finalTicketId = document.getElementById("final_ticket_id");
            const finalRequestType = document.getElementById("final_request_type");
            const finalTitle = document.getElementById("final_title");
            const finalDescription = document.getElementById("final_description");
            const ticketItems = document.querySelectorAll(".ticket-item");
            const ticketDetailSpans = {
                date: document.getElementById("ticketDate"),
                email: document.getElementById("ticketEmail"),
                requestType: document.getElementById("ticketRequestType"),
                title: document.getElementById("ticketTitle"),
                description: document.getElementById("ticketDescription")
            };
            let selectedTicketId = null;

            // Custom alert
            const customAlert = document.getElementById("customAlert");
            const alertMessage = document.getElementById("alertMessage");
            const okayButton = document.getElementById("alertOkayButton");

            function showAlert(message) {
                alertMessage.textContent = message;
                customAlert.style.display = "flex";
            }

            function hideAlert() {
                customAlert.style.display = "none";
            }

            okayButton.addEventListener("click", hideAlert);

            // Ticket selection and edit form
            ticketItems.forEach(item => {
                item.addEventListener("click", function() {
                    // Remove selection from other items
                    ticketItems.forEach(otherItem => {
                        otherItem.classList.remove("selected-ticket");
                    });
                    // Add selection to the clicked item
                    this.classList.add("selected-ticket");
                    selectedTicketId = this.dataset.ticketId;
                    requestTypeEdit.value = this.dataset.requestType;
                    titleEdit.value = this.dataset.title;
                    descriptionEdit.value = this.dataset.description;

                    // Enable the submit changes button
                    submitEditDetailsButton.disabled = false;
                });
            });

            submitEditDetailsButton.addEventListener("click", function(event) {
                event.preventDefault();

                if (selectedTicketId) {
                    const requestType = requestTypeEdit.value;
                    const title = titleEdit.value;
                    const description = descriptionEdit.value;

                    // Update ticket details display
                    ticketDetailSpans.date.textContent = new Date().toLocaleDateString();
                    ticketDetailSpans.email.textContent = "[User Email]";
                    ticketDetailSpans.requestType.textContent = requestType;
                    ticketDetailSpans.title.textContent = title;
                    ticketDetailSpans.description.textContent = description;

                    // Update hidden form fields for final submission
                    finalTicketId.value = selectedTicketId;
                    finalRequestType.value = requestType;
                    finalTitle.value = title;
                    finalDescription.value = description;

                    // Disable the edit form
                    requestTypeEdit.disabled = true;
                    titleEdit.disabled = true;
                    descriptionEdit.disabled = true;
                    submitEditDetailsButton.disabled = true;

                    // Enable the confirm update buttons
                    editDetailsButton.disabled = false;
                    updateTicketFinalButton.disabled = false;
                } else {
                    showAlert("Please select a ticket to update.");
                }
            });

            editDetailsButton.addEventListener("click", function() {
                // Re-enable the edit form
                requestTypeEdit.disabled = false;
                titleEdit.disabled = false;
                descriptionEdit.disabled = false;
                submitEditDetailsButton.disabled = false;

                // Disable the confirm update buttons
                editDetailsButton.disabled = true;
                updateTicketFinalButton.disabled = true;
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const logoutButton = document.querySelector(".logout-button");
            const customAlertLogout = document.getElementById("customAlertLogout");
            const alertYesButton = document.getElementById("alertYesButton");
            const alertNoButton = document.getElementById("alertNoButton");

            if (logoutButton) {
                logoutButton.addEventListener("click", function(event) {
                    event.preventDefault();
                    customAlertLogout.style.display = "flex";
                });
            }

            alertYesButton.addEventListener("click", function() {
                window.location.href = "{{ url_for('auth.logout') }}";
            });

            alertNoButton.addEventListener("click", function() {
                customAlertLogout.style.display = "none";
            });
        });
    </script>
</body>
</html>
