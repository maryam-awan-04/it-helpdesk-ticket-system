{% extends 'user/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
    <div class="dashboard-summary">
        <div class="summary-box">
            <h2>Open</h2>
            <div class="count">{% if open_tickets %}{{ open_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>In Progress</h2>
            <div class="count">{% if in_progress_tickets %}{{ in_progress_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>On Hold</h2>
            <div class="count">{% if on_hold_tickets %}{{ on_hold_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>Resolved</h2>
            <div class="count">{% if resolved_tickets %}{{ resolved_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>Closed</h2>
            <div class="count">{% if closed_tickets %}{{ closed_tickets|length }}{% else %}0{% endif %}</div>
        </div>
    </div>
    <div class="ticket-history-container">
        <div class="ticket-history-header">
            <h2>Ticket History</h2>
            <div class="filter-container">
                <label for="filterBy" class="filter-label">Filter By:</label>
                <select id="filterBy" class="filter-select">
                    <option value="">All</option>
                    <option value="date">Date</option>
                    <option value="request_type">Request Type</option>
                    <option value="status">Status</option>
                    <option value="title">Title</option>
                </select>
            </div>
        </div>
        <table class="ticket-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date Opened</th>
                    <th>Request Type</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Assigned To</th>
                    <th>Status</th>
                    <th>Feedback</th>
                </tr>
            </thead>
            <tbody>
                {% if all_tickets %}
                    {% for ticket in all_tickets %}
                        <tr>
                            <td>{{ ticket.id }}</td>
                            <td>{{ ticket.date_opened }}</td>
                            <td>{{ ticket.request_type }}</td>
                            <td>{{ ticket.title }}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">{{ ticket.description }}</td>
                            <td>{{ ticket.assigned_user.firstname }} {{ ticket.assigned_user.surname }}</td>
                            <td>{{ ticket.status }}</td>
                            <td>{% if ticket.status == 'Resolved' %}
                                <button class="feedback-button" onclick="openFeedback({{ ticket.id }})">Give Feedback</button>
                                {% elif ticket.feedback %}
                                <div class="star-display">
                                    {% for i in range(ticket.feedback|int) %}
                                        <span class="star">&#9733;</span>
                                    {% endfor %}
                                    {% for i in range(5 - (ticket.feedback|int)) %}
                                        <span class="empty-star">&#9734;</span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4">No ticket history available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div>
        <form id="feedbackForm" method="POST" action="{{ url_for('user.submit_feedback') }}">
            {{ feedback_form.hidden_tag() }}
            <input type="hidden" name="id" id="feedback-ticket-id">

            <div id="feedback-popup" class="popup-overlay hidden">
              <div class="popup-content">
                <h2>Rate This Ticket</h2>

                <div class="star-rating">
                    <input type="radio" id="star5" name="{{ feedback_form.rating.name }}" value="5">
                    <label for="star5">&#9733;</label>
                    <input type="radio" id="star4" name="{{ feedback_form.rating.name }}" value="4">
                    <label for="star4">&#9733;</label>
                    <input type="radio" id="star3" name="{{ feedback_form.rating.name }}" value="3">
                    <label for="star3">&#9733;</label>
                    <input type="radio" id="star2" name="{{ feedback_form.rating.name }}" value="2">
                    <label for="star2">&#9733;</label>
                    <input type="radio" id="star1" name="{{ feedback_form.rating.name }}" value="1">
                    <label for="star1">&#9733;</label>
                </div>

                <div id="feedback-error" class="errors"></div>

                <button type="submit" id="alertOkayButton">Submit</button>
              </div>
            </div>
        </form>
    </div>

    <script>
        const feedbackPopup = document.getElementById("feedback-popup");
        const feedbackTicketIdInput = document.getElementById("feedback-ticket-id");

        function openFeedback(ticketId) {
            feedbackTicketIdInput.value = ticketId;
            feedbackPopup.classList.remove("hidden");
        }

        function closeFeedback() {
            feedbackPopup.classList.add("hidden");
        }

        window.addEventListener("click", (event) => {
            if (event.target == feedbackPopup) {
                closeFeedback();
            }
        });
    </script>
{% endblock %}
