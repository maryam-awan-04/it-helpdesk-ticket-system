{% extends 'user/base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
    <div class="dashboard-summary">
        <div class="summary-box">
            <h2>Open</h2>
            <div class="count">{% if open_tickets %}{{ open_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>In Progress</h2>
            <div class="count">{% if in_progress_tickets %}{{ in_progress_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>On Hold</h2>
            <div class="count">{% if on_hold_tickets %}{{ on_hold_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>Resolved</h2>
            <div class="count">{% if resolved_tickets %}{{ resolved_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="summary-box">
            <h2>Closed</h2>
            <div class="count">{% if closed_tickets %}{{ closed_tickets|length }}{% else %}0{% endif %}</div>
        </div>
    </div>
    <div class="ticket-history-container">
        <div class="ticket-history-header">
            <h2>Ticket History</h2>
            <div class="filter-container">
                <label for="filterBy" class="filter-label">Filter By:</label>
                <select id="filterBy" class="filter-select">
                    <option value="">All</option>
                    <option value="date">Date</option>
                    <option value="request_type">Request Type</option>
                    <option value="status">Status</option>
                    <option value="title">Title</option>
                </select>
            </div>
        </div>
        <table class="ticket-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date Opened</th>
                    <th>Request Type</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Assigned To</th>
                    <th>Status</th>
                    <th>Feedback Score</th>
                </tr>
            </thead>
            <tbody>
                {% if all_tickets %}
                    {% for ticket in all_tickets %}
                        <tr>
                            <td>{{ ticket.id }}</td>
                            <td>{{ ticket.date_opened }}</td>
                            <td>{{ ticket.request_type }}</td>
                            <td>{{ ticket.title }}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">{{ ticket.description }}</td>
                            <td>{{ ticket.assigned_to }}</td>
                            <td>{{ ticket.status }}</td>
                            <td>{{ ticket.feedback_score }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4">No ticket history available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div>
        <form id="feedbackForm" method="POST">
            {{ feedback_form.hidden_tag() }}
            <input type="hidden" name="ticket_id" id="feedback-ticket-id">

            <div id="feedback-popup" class="popup-overlay hidden">
              <div class="popup-content">
                <h2>Rate This Ticket</h2>

                <div class="star-rating">
                  {% for value, label in feedback_form.rating.choices %}
                  <input type="radio" id="star{{ value }}" name="{{ feedback_form.rating.name }}" value="{{ value }}">
                  <label for="star{{ value }}">&#9733;</label>
                  {% endfor %}
                </div>

                <div id="feedback-error" class="errors"></div>

                <button type="submit" id="alertOkayButton">Submit</button>
              </div>
            </div>
        </form>
    </div>

    <script>
        function openFeedback(ticketId) {
            document.getElementById("feedback-ticket-id").value = ticketId;
            document.getElementById("feedback-popup").classList.remove("hidden");
        }

        document.getElementById("feedbackForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch("/user.submit-feedback", {
            method: "POST",
            body: formData
        }).then(res => res.json())
            .then(data => {
            if (data.success) {
                closeFeedback();
                alert(data.message);
                location.reload();
            } else {
                document.getElementById("feedback-error").textContent = data.errors?.rating?.[0] || "Something went wrong.";
            }
            }).catch(() => {
            document.getElementById("feedback-error").textContent = "Network error.";
            });
        });

    </script>
{% endblock %}
