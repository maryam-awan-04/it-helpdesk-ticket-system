{% extends 'admin/base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
    <div class="assigned-summary">
        <div class="assigned-summary-box">
            <h2>My Assigned Tickets</h2>
            <div class="count">{% if assigned_tickets %}{{ assigned_tickets|length }}{% else %}0{% endif %}</div>
        </div>
        <div class="assigned-summary-box">
            <h2>My Tickets In Progress</h2>
            <div class="count">{% if in_progress_tickets %}{{ in_progress_tickets|length }}{% else %}0{% endif %}</div>
        </div>
    </div>

    <div class="assigned-tickets">
        <div class="assigned-tickets-box">
            <h2>My Assigned Tickets</h2>
            <div class="filter-options">
                <div class="custom-dropdown">
                    <label for="status-filter-toggle">Filter by Status:</label>
                    <div class="dropdown-toggle" id="status-filter-toggle" onclick="toggleDropdown('status-dropdown')">
                        <span>All</span>
                    </div>
                    <div class="dropdown-content" id="status-dropdown">
                        <label>
                            <input type="radio" name="status" value="" onchange="updateSelected(this, 'status-filter-toggle')">
                            All
                        </label>
                        {% for status in status_options %}
                        <label>
                            <input type="radio" name="status" value="{{ status }}" onchange="updateSelected(this, 'status-filter-toggle')">
                            {{ status }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div class="custom-dropdown">
                    <label for="request-type-filter-toggle">Filter by Request Type:</label>
                    <div class="dropdown-toggle" id="request-type-filter-toggle" onclick="toggleDropdown('request-type-dropdown')">
                        <span>All</span>
                    </div>
                    <div class="dropdown-content" id="request-type-dropdown">
                        <label>
                            <input type="radio" name="request_type" value="" onchange="updateSelected(this, 'request-type-filter-toggle')">
                            All
                        </label>
                        {% for request_type in request_type_options %}
                        <label>
                            <input type="radio" name="request_type" value="{{ request_type }}" onchange="updateSelected(this, 'request-type-filter-toggle')">
                            {{ request_type }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <button onclick="applyFilters()">Apply Filters</button>
                    <button onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>
        </div>
        <table class="ticket-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date Opened</th>
                    <th>Request Type</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Feedback Score</th>
                </tr>
            </thead>
            <tbody>
                {% if assigned_tickets %}
                    {% for ticket in assigned_tickets %}
                        <tr>
                            <td>{{ ticket.id }}</td>
                            <td>{{ ticket.date_opened }}</td>
                            <td>{{ ticket.request_type }}</td>
                            <td>{{ ticket.title }}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">{{ ticket.description }}</td>
                            <td>{{ ticket.status }}</td>
                            <td>{{ ticket.feedback_score }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4">No ticket history available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="unassigned-tickets">
        <div class="unassigned-tickets-box">
            <h2>Open Unassigned Tickets</h2>
            <div class="filter-options">
                <div class="custom-dropdown">
                    <label for="request-type-filter-toggle">Filter by Request Type:</label>
                    <div class="dropdown-toggle" id="request-type-filter-toggle" onclick="toggleDropdown('request-type-dropdown')">
                        <span>All</span>
                    </div>
                    <div class="dropdown-content" id="request-type-dropdown">
                        <label>
                            <input type="radio" name="request_type" value="" onchange="updateSelected(this, 'request-type-filter-toggle')">
                            All
                        </label>
                        {% for request_type in request_type_options %}
                        <label>
                            <input type="radio" name="request_type" value="{{ request_type }}" onchange="updateSelected(this, 'request-type-filter-toggle')">
                            {{ request_type }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <button onclick="applyFilters()">Apply Filters</button>
                    <button onclick="clearFilters()">Clear Filters</button>
                </div>
            </div>
        </div>
        <table class="ticket-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date Opened</th>
                    <th>Request Type</th>
                    <th>Title</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                {% if unassigned_tickets %}
                    {% for ticket in unassigned_tickets %}
                        <tr>
                            <td>{{ ticket.id }}</td>
                            <td>{{ ticket.date_opened }}</td>
                            <td>{{ ticket.request_type }}</td>
                            <td>{{ ticket.title }}</td>
                            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">{{ ticket.description }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4">No ticket history available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script>
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function applyFilters() {
            const statusFilterElements = document.querySelectorAll("#status-dropdown input[name='status']:checked");
            const statusFilter = Array.from(statusFilterElements)
                                    .map(input => input.value)
                                    .filter(value => value !== "");

            const typeFilterElements = document.querySelectorAll("#request-type-dropdown input[name='request_type']:checked");
            const typeFilter = Array.from(typeFilterElements)
                                  .map(input => input.value)
                                  .filter(value => value !== "");

            let queryParams = [];
            if (statusFilter.length > 0) {
                statusFilter.forEach(status => queryParams.push(`status=${encodeURIComponent(status)}`));
            }
            if (typeFilter.length > 0) {
                typeFilter.forEach(type => queryParams.push(`request_type=${encodeURIComponent(type)}`));
            }

            const queryString = queryParams.join("&");
            window.location.href = `/admin/dashboard${queryString ? "?" + queryString : ""}`;
        }

        function clearFilters() {
            window.location.href = "/admin/dashboard";
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        function updateSelected(radio, toggleId) {
            const toggleButton = document.getElementById(toggleId).querySelector("span");
            toggleButton.textContent = radio.value || "All " + toggleId.replace("-filter-toggle", "").replace("-dropdown", "").split("-").map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(" ");
            const dropdownId = toggleId.replace("-filter-toggle", "-dropdown");
            document.getElementById(dropdownId).style.display = "none";
        }

        window.onclick = function(event) {
            if (!event.target.matches(".dropdown-toggle")) {
                const dropdowns = document.querySelectorAll(".dropdown-content");
                dropdowns.forEach(dropdown => {
                    if (dropdown.style.display === "block") {
                        dropdown.style.display = "none";
                    }
                });
            }
        }

        function initialiseFilters() {
            const statusParams = new URLSearchParams(window.location.search).getAll("status");
            const typeParams = new URLSearchParams(window.location.search).getAll("request_type");

            document.querySelectorAll("#status-dropdown input[name='status']").forEach(radio => {
                if (statusParams.includes(radio.value)) {
                    radio.checked = true;
                }
            });
            const selectedStatusesText = statusParams.length > 0 ? statusParams.join(", ") : "All";
            document.getElementById("status-filter-toggle").querySelector("span").textContent = selectedStatusesText;

            document.querySelectorAll("#request-type-dropdown input[name='request_type']").forEach(radio => {
                if (typeParams.includes(radio.value)) {
                    radio.checked = true;
                }
            });
            const selectedTypesText = typeParams.length > 0 ? typeParams.join(", ") : "All";
            document.getElementById("request-type-filter-toggle").querySelector("span").textContent = selectedTypesText;
        }

        window.onload = initialiseFilters;
    </script>
{% endblock %}
