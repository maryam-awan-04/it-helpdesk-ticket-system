{% extends 'admin/base.html' %}
{% block title %}Manage Users{% endblock %}
{% block content %}
    <div class="user-list-container">
        <div class="user-list-header">
            <h2>User Information</h2>
        </div>
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Surname</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if all_users %}
                    {% for user in all_users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td>{{ user.firstname }}</td>
                            <td>{{ user.surname }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.role }}</td>
                            <td>
                                <button type="button" class="edit-button user-edit-button" data-user-id="{{ user.id }}"
                                        data-firstname="{{ user.firstname }}" data-surname="{{ user.surname }}"
                                        data-email="{{ user.email }}" data-role="{{ user.role }}">Edit</button>
                                <button type="button" class="delete-button user-delete-button" data-user-id="{{ user.id }}">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6">No user information available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div id="editPopup" class="popup">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <h2>Edit User Details</h2>
            <form method="POST" id="editUserForm">
                {{ form.hidden_tag() }}
                <input type="hidden" id="user_id" name="id">
                <div class="form-group">
                    <label for="firstname">{{ form.firstname.label }}</label>
                    {{ form.firstname(class="form-control", id="firstname") }}
                    {% if form.firstname.errors %}
                        <ul class="errors">
                            {% for error in form.firstname.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="surname">{{ form.surname.label }}</label>
                    {{ form.surname(class="form-control", id="surname") }}
                    {% if form.surname.errors %}
                        <ul class="errors">
                            {% for error in form.surname.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="email">{{ form.email.label }}</label>
                    {{ form.email(class="form-control", id="email") }}
                    {% if form.email.errors %}
                        <ul class="errors">
                            {% for error in form.email.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="role">{{ form.role.label }}</label>
                    {{ form.role(class="form-control", id="role") }}
                    {% if form.role.errors %}
                        <ul class="errors">
                            {% for error in form.role.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <button type="submit" class="submit-button">Submit Changes</button>
            </form>
        </div>
    </div>

    <div id="deleteConfirmationPopup" class="popup">
        <div class="popup-content">
            <span class="close-button" id="closeDeletePopup">&times;</span>
            <h2>Confirm Delete</h2>
            <p>Are you sure you want to delete this user?</p>
            <div class="button-container">
                <form method="POST" id="deleteUserForm">
                    {{ form.hidden_tag() }}
                    <input type="hidden" id="delete_user_id" name="delete_user_id">
                    <button type="submit" class="delete-button" name="delete_user">Delete</button>
                </form>
                <button type="button" class="cancel-button" id="cancelDelete">Cancel</button>
            </div>
        </div>
    </div>

    <div id="customAlert" class="custom-alert">
        <div class="alert-content">
            <p id="alertMessage"></p>
            <button id="alertOkayButton">Okay</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const editPopup = document.getElementById("editPopup");
            const deleteConfirmationPopup = document.getElementById("deleteConfirmationPopup");
            const closeEditPopupButton = editPopup.querySelector(".close-button");
            const closeDeletePopupButton = document.getElementById("closeDeletePopup");
            const cancelDeleteButton = document.getElementById("cancelDelete");
            const editUserForm = document.getElementById("editUserForm");
            const editUserIdInput = document.getElementById("user_id");
            const editFirstnameInput = document.getElementById("firstname");
            const editSurnameInput = document.getElementById("surname");
            const editEmailInput = document.getElementById("email");
            const editRoleInput = document.getElementById("role");
            const deleteUserIdInput = document.getElementById("delete_user_id");
            const userEditButtons = document.querySelectorAll(".user-edit-button");
            const userDeleteButtons = document.querySelectorAll(".user-delete-button");

            // Custom alert
            const customAlert = document.getElementById("customAlert");
            const alertMessage = document.getElementById("alertMessage");
            const okayButton = document.getElementById("alertOkayButton");

            function showAlert(message) {
                alertMessage.textContent = message;
                customAlert.style.display = "flex";
            }

            function hideAlert() {
                customAlert.style.display = "none";
            }

            okayButton.addEventListener("click", hideAlert);

            // Edit popup functionality
            userEditButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const userId = this.dataset.userId;
                    const firstname = this.dataset.firstname;
                    const surname = this.dataset.surname;
                    const email = this.dataset.email;
                    const role = this.dataset.role;

                    editUserIdInput.value = userId;
                    editFirstnameInput.value = firstname;
                    editSurnameInput.value = surname;
                    editEmailInput.value = email;
                    editRoleInput.value = role;

                    editPopup.style.display = "block";
                });
            });

            closeEditPopupButton.addEventListener("click", function() {
                editPopup.style.display = "none";
            });

            // Delete confirmation functionality
            userDeleteButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const userId = this.dataset.userId;
                    deleteUserIdInput.value = userId;
                    deleteConfirmationPopup.style.display = "block";
                });
            });

            closeDeletePopupButton.addEventListener("click", function() {
                deleteConfirmationPopup.style.display = "none";
            });

            cancelDeleteButton.addEventListener("click", function() {
                deleteConfirmationPopup.style.display = "none";
            });

            // Close modal when clicking outside
            window.addEventListener("click", function(event) {
                if (event.target == editPopup) {
                    editPopup.style.display = "none";
                }
                if (event.target == deleteConfirmationPopup) {
                    deleteConfirmationPopup.style.display = "none";
                }
            });
        });
    </script>
{% endblock %}
