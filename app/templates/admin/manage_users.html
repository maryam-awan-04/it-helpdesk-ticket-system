{% extends 'admin/base.html' %}
{% block title %}Manage Users{% endblock %}
{% block content %}
    <div class="user-list-container">
        <div class="user-list-header">
            <h2>User Information</h2>
            <div class="filter-options">
                <div class="custom-dropdown">
                    <label for="role-filter-toggle">Filter by Role:</label>
                    <div class="dropdown-toggle" id="role-filter-toggle" onclick="toggleDropdown('role-dropdown')">
                        <span>All</span>
                    </div>
                    <div class="dropdown-content" id="role-dropdown">
                        <label>
                            <input type="radio" name="role" value="" onchange="updateSelected(this, 'role-filter-toggle')">
                            All
                        </label>
                        {% for role in role_options %}
                        <label>
                            <input type="radio" name="role" value="{{ role }}" onchange="updateSelected(this, 'role-filter-toggle')">
                            {{ role }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <button onclick="applyFilters()">Apply Filters</button>
                    <button onclick="clearFilters()">Clear Filters</button>
                </div>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search">
                    <button type="button" id="search-button">Search</button>
                </div>
            </div>
        </div>
        <table class="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Surname</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if all_users %}
                    {% for user in all_users %}
                        <tr>
                            <td>{{ user.id }}</td>
                            <td class="firstname">{{ user.firstname }}</td>
                            <td class="surname">{{ user.surname }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.role }}</td>
                            <td>
                                <button type="button" class="edit-button user-edit-button" data-user-id="{{ user.id }}"
                                        data-firstname="{{ user.firstname }}" data-surname="{{ user.surname }}"
                                        data-email="{{ user.email }}" data-role="{{ user.role }}">Edit</button>
                                <button type="button" class="delete-button user-delete-button" data-user-id="{{ user.id }}">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="6">No user information available.</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div id="editPopup" class="popup">
        <div class="popup-content">
            <span class="close-button">&times;</span>
            <h2>Edit User Details</h2>
            <form method="POST" id="editUserForm">
                {{ form.hidden_tag() }}
                <input type="hidden" id="user_id" name="id">
                <div class="form-group">
                    <label for="firstname">{{ form.firstname.label }}</label>
                    {{ form.firstname(class="form-control", id="firstname") }}
                    {% if form.firstname.errors %}
                        <ul class="errors">
                            {% for error in form.firstname.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="surname">{{ form.surname.label }}</label>
                    {{ form.surname(class="form-control", id="surname") }}
                    {% if form.surname.errors %}
                        <ul class="errors">
                            {% for error in form.surname.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="email">{{ form.email.label }}</label>
                    {{ form.email(class="form-control", id="email") }}
                    {% if form.email.errors %}
                        <ul class="errors">
                            {% for error in form.email.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label for="role">{{ form.role.label }}</label>
                    {{ form.role(class="form-control", id="role") }}
                    {% if form.role.errors %}
                        <ul class="errors">
                            {% for error in form.role.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
                <button type="submit" class="submit-button">Submit Changes</button>
            </form>
        </div>
    </div>

    <div id="deleteConfirmationPopup" class="popup">
        <div class="popup-content">
            <span class="close-button" id="closeDeletePopup">&times;</span>
            <h2>Confirm Delete</h2>
            <p>Are you sure you want to delete this user?</p>
            <div class="button-container">
                <form method="POST" id="deleteUserForm">
                    {{ form.hidden_tag() }}
                    <input type="hidden" id="delete_user_id" name="delete_user_id">
                    <button type="submit" class="delete-button" name="delete_user">Delete</button>
                </form>
                <button type="button" class="cancel-button" id="cancelDelete">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const editPopup = document.getElementById("editPopup");
            const deleteConfirmationPopup = document.getElementById("deleteConfirmationPopup");
            const closeEditPopupButton = editPopup.querySelector(".close-button");
            const closeDeletePopupButton = document.getElementById("closeDeletePopup");
            const cancelDeleteButton = document.getElementById("cancelDelete");
            const editUserForm = document.getElementById("editUserForm");
            const editUserIdInput = document.getElementById("user_id");
            const editFirstnameInput = document.getElementById("firstname");
            const editSurnameInput = document.getElementById("surname");
            const editEmailInput = document.getElementById("email");
            const editRoleInput = document.getElementById("role");
            const deleteUserIdInput = document.getElementById("delete_user_id");
            const userEditButtons = document.querySelectorAll(".user-edit-button");
            const userDeleteButtons = document.querySelectorAll(".user-delete-button");

            const flashes = {{ get_flashed_messages(with_categories=True) | tojson }};

            if (flashes.length > 0) {
                flashes.forEach(function(flash) {
                    alert(flash[1]);
                });
            }

            // Edit popup functionality
            userEditButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const userId = this.dataset.userId;
                    const firstname = this.dataset.firstname;
                    const surname = this.dataset.surname;
                    const email = this.dataset.email;
                    const role = this.dataset.role;

                    editUserIdInput.value = userId;
                    editFirstnameInput.value = firstname;
                    editSurnameInput.value = surname;
                    editEmailInput.value = email;
                    editRoleInput.value = role;

                    editPopup.style.display = "block";
                });
            });

            closeEditPopupButton.addEventListener("click", function() {
                editPopup.style.display = "none";
            });

            // Delete confirmation functionality
            userDeleteButtons.forEach(button => {
                button.addEventListener("click", function() {
                    const userId = this.dataset.userId;
                    deleteUserIdInput.value = userId;
                    deleteConfirmationPopup.style.display = "block";
                });
            });

            closeDeletePopupButton.addEventListener("click", function() {
                deleteConfirmationPopup.style.display = "none";
            });

            cancelDeleteButton.addEventListener("click", function() {
                deleteConfirmationPopup.style.display = "none";
            });

            // Close popup when clicking outside
            window.addEventListener("click", function(event) {
                if (event.target == editPopup) {
                    editPopup.style.display = "none";
                }
                if (event.target == deleteConfirmationPopup) {
                    deleteConfirmationPopup.style.display = "none";
                }
            });
        });

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function applyFilters() {
            const roleFilterElements = document.querySelectorAll("#role-dropdown input[name='role']:checked");
            const roleFilter = Array.from(roleFilterElements)
                                    .map(input => input.value)
                                    .filter(value => value !== "");

            let queryParams = [];
            if (roleFilter.length > 0) {
                roleFilter.forEach(role => queryParams.push(`role=${encodeURIComponent(role)}`));
            }

            const queryString = queryParams.join("&");
            window.location.href = `/admin/manage-users${queryString ? "?" + queryString : ""}`;
        }

        function clearFilters() {
            window.location.href = "/admin/manage-users";
        }

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        }

        function updateSelected(radio, toggleId) {
            const toggleButton = document.getElementById(toggleId).querySelector("span");
            toggleButton.textContent = radio.value || "All " + toggleId.replace("-filter-toggle", "").replace("-dropdown", "").split("-").map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(" ");
            const dropdownId = toggleId.replace("-filter-toggle", "-dropdown");
            document.getElementById(dropdownId).style.display = "none";
        }

        window.onclick = function(event) {
            if (!event.target.matches(".dropdown-toggle")) {
                const dropdowns = document.querySelectorAll(".dropdown-content");
                dropdowns.forEach(dropdown => {
                    if (dropdown.style.display === "block") {
                        dropdown.style.display = "none";
                    }
                });
            }
        }

        function initialiseFilters() {
            const roleParams = new URLSearchParams(window.location.search).getAll("role");

            document.querySelectorAll("#role-dropdown input[name='role']").forEach(radio => {
                if (roleParams.includes(radio.value)) {
                    radio.checked = true;
                }
            });
            const selectedRolesText = roleParams.length > 0 ? roleParams.join(", ") : "All";
            document.getElementById("role-filter-toggle").querySelector("span").textContent = selectedRolesText;
        }

        window.onload = initialiseFilters;

        const searchInput = document.getElementById("search-input");
        const searchButton = document.getElementById("search-button");
        const userTableRows = document.querySelectorAll(".user-table tbody tr");

        searchButton.addEventListener("click", function() {
            const searchTerm = searchInput.value.toLowerCase();
            userTableRows.forEach(row => {
                const firstName = row.querySelector(".firstname").textContent.toLowerCase();
                const surname = row.querySelector(".surname").textContent.toLowerCase();
                if (firstName.includes(searchTerm) || surname.includes(searchTerm)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        });
    </script>
{% endblock %}
